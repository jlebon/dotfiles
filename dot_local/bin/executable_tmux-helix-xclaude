#!/bin/bash
set -euo pipefail
shopt -s inherit_errexit

# Send a query to an xclaude instance running in the same tmux window.
#
# Modes based on how it's called:
#   tmux-helix-xclaude: send file/line context, switch focus (for helix hotkey)
#   xch: send file/line context + arguments, press Enter
#   xc:  send just the arguments, press Enter (no file/line prefix)

export HOST_SPAWN_QUIET=1

mode=$(basename "$0")

current_window=$(tmux display-message -p '#{window_id}')

# Find all xclaude containers and look for one matching our window
target_pane=""
while read -r container_id; do
    window_label=$(podman inspect --format '{{index .Config.Labels "TMUX_WINDOW"}}' "$container_id")
    if [ "$window_label" = "$current_window" ]; then
        target_pane=$(podman inspect --format '{{index .Config.Labels "TMUX_PANE"}}' "$container_id")
        break
    fi
done < <(podman ps --filter=label=xclaude=1 --format '{{.ID}}')

if [ -z "$target_pane" ]; then
    echo "ERROR: No xclaude instance found for window $current_window" >&2
    exit 1
fi

# Send to the xclaude pane based on mode
case "$mode" in
    xc)
        tmux send-keys -t "$target_pane" "$*"
        tmux send-keys -t "$target_pane" Enter
        ;;
    xch)
        # Wait a bit for helix to hide the command box so we can read the status line
        sleep 0.25
        file=$(tmux-helix-bufinfo file)
        line=$(tmux-helix-bufinfo line)
        tmux send-keys -t "$target_pane" "in file $file at line $line: $*"
        tmux send-keys -t "$target_pane" Enter
        ;;
    *)
        # tmux-helix-xclaude: focus mode for helix hotkey
        file=$(tmux-helix-bufinfo file)
        line=$(tmux-helix-bufinfo line)
        tmux send-keys -t "$target_pane" "in file $file at line $line: "
        tmux select-pane -t "$target_pane"
        ;;
esac
