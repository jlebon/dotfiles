#!/bin/bash
set -euo pipefail

## Navigation:
## 
## Select up/down                   Ctrl-K, Ctrl-J
## Scroll commits up/down           Ctrl-U, Ctrl-D
## Scroll preview up/down           Alt-U, Alt-D
## Scroll preview up/down one line  Alt-Y, Alt-E
## 
## Git operations:
## 
## Checkout branch  Enter
## Delete branch    Ctrl-R
## Browse branch    Ctrl-Space
## 
## Misc:
## 
## Show this help                         F1
## Change preview location                F2
## Toggle preview                         Ctrl-/
## Copy branch names to tmux and stdout   Ctrl-G

# XXX: Ctrl-R -> rename, Ctrl-X -> delete?
# XXX: prompt for deletion?

if [ "$(git rev-parse --is-inside-work-tree 2>/dev/null)" != "true" ]; then
    echo "error: not inside a git repo" >&2
    exit 1
fi

if [ "${1:-}" = command ]; then
    # we sort by last visited using the reflog
    # first, get branch names from reflog, pass through xargs echo to squash
    # blank lines and make multiple branches on same line become distinct, then
    # remove the 'HEAD ->' bits, trailing commas, and make unique
    # git reflog --format='format:%D' | \
    #     xargs -n1 echo | \
    #     grep -v -e '/' -e '->' -e '^HEAD$' | sed -e 's/,$//g' | awk '!a[$0]++'  
    # git reflog --format='%(decorate:prefix=,suffix=,separator=|)' | \
    #     xargs -d '|' -n1 echo | grep -v -e ' -> ' -e '/' -e '^$' -e 'tag: ' | awk '!a[$0]++'
    # XXX: not sure why I didn't use this before:
    default_local=$(git default -l)
    git branch -v --sort=-committerdate --format "%(refname:lstrip=2)" | grep -v "^${default_local}$"
    exit 0
elif [ "${1:-}" = preview ]; then
    default_ref=$(git default -r)
    merge_base=$(git merge-base "${default_ref}" "$2") # $2
    git lg --color=always "$2" "^${merge_base}"
    echo
    printf '%.sâ”€' $(seq 1 $COLUMNS)
    git diff --color=always "${merge_base}" "$2" 
    exit 0
fi

export FZF_DEFAULT_COMMAND="$0 command"
# export FZF_DEFAULT_COMMAND="git branch --color=always --format '%(authordate:short)%(color:bold)  %(refname:lstrip=2)' --sort=authordate $* | tac"

tmux=true
if [ -n "${TMUX:-}" ]; then
    tmux=tmux
fi

fzf --track --ansi --tiebreak=index -m -d '  ' \
    --header 'Enter: checkout | C-Space: log | C-r: delete | C-f: delete -D | C-g: copy' \
    --preview "$0 preview {1}" \
    --bind "f1:execute(grep '^## ' '$0' | cut -f2- -d' ' | less)" \
    --bind 'f2:change-preview-window(down|right)' \
    --bind 'ctrl-d:half-page-down,ctrl-u:half-page-up' \
    --bind 'alt-e:preview-down,alt-y:preview-up,alt-d:preview-half-page-down,alt-u:preview-half-page-up' \
    --bind 'enter:become:git checkout {1}' \
    --bind 'ctrl-space:execute:git lgi {1}' \
    --bind 'ctrl-r:execute:git branch -d {+1}' \
    --bind "ctrl-r:+reload:${FZF_DEFAULT_COMMAND}" \
    --bind 'ctrl-f:execute:git branch -D {+1}' \
    --bind "ctrl-f:+reload:${FZF_DEFAULT_COMMAND}" \
    --bind 'ctrl-/:toggle-preview' \
    --bind "ctrl-g:become:$tmux set-buffer '{+1}' && echo {+1}"
