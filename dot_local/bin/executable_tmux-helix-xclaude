#!/bin/bash
set -euo pipefail
shopt -s inherit_errexit

# Send a query to a claude/opencode instance running in the same tmux window.
#
# Modes based on how it's called:
#   tmux-helix-xclaude: send file/line context, switch focus (for helix hotkey)
#   xch: send file/line context + arguments, press Enter
#   xc:  send just the arguments, press Enter (no file/line prefix)

export HOST_SPAWN_QUIET=1

mode=$(basename "$0")

current_window=$(tmux display-message -p '#{window_id}')

# Find all claude/opencode containers and look for one matching our window
target_pane=""
container_type=""
for label in claude opencode; do
    while read -r container_id; do
        [ -z "$container_id" ] && continue
        window_label=$(podman inspect --format '{{index .Config.Labels "TMUX_WINDOW"}}' "$container_id")
        if [ "$window_label" = "$current_window" ]; then
            target_pane=$(podman inspect --format '{{index .Config.Labels "TMUX_PANE"}}' "$container_id")
            container_type="$label"
            break 2
        fi
    done < <(podman ps --filter=label="${label}=1" --format '{{.ID}}')
done

if [ -z "$target_pane" ]; then
    echo "ERROR: No AI assistant instance found for window $current_window" >&2
    exit 1
fi

# Expand pane if it's minimized (1 row)
pane_height=$(tmux display-message -p -t "$target_pane" '#{pane_height}')
if [ "$pane_height" -eq 1 ]; then
    tmux resize-pane -t "$target_pane" -y 999
fi

# Send to the xclaude pane based on mode
clear_input() {
    if [ "$container_type" = "opencode" ]; then
        # OpenCode: Shift-Home to select all, then Backspace to delete
        tmux send-keys -t "$target_pane" S-Home
        tmux send-keys -t "$target_pane" BSpace
    else
        # Claude: Home + Ctrl-K loop
        # there's Esc Esc also, but that would also stop Claude execution if it's currently working
        for i in {1..10}; do
            tmux send-keys -t "$target_pane" Home
            sleep 0.01
            tmux send-keys -t "$target_pane" C-k
        done
    fi
}

case "$mode" in
    xc)
        clear_input
        tmux send-keys -t "$target_pane" "$*"
        tmux send-keys -t "$target_pane" Enter
        ;;
    xch)
        # Wait a bit for helix to hide the command box so we can read the status line
        sleep 0.25
        file=$(tmux-helix-bufinfo file)
        line=$(tmux-helix-bufinfo line)
        clear_input
        tmux send-keys -t "$target_pane" "in file $file at line $line: $*"
        tmux send-keys -t "$target_pane" Enter
        ;;
    *)
        # tmux-helix-xclaude: focus mode for helix hotkey
        file=$(tmux-helix-bufinfo file)
        line=$(tmux-helix-bufinfo line)
        clear_input
        tmux send-keys -t "$target_pane" "in file $file at line $line (reread the file carefully, it may have changed): "
        tmux select-pane -t "$target_pane"
        ;;
esac
