#!/bin/bash
set -euo pipefail

# Based on https://github.com/junegunn/fzf.vim/issues/211#issuecomment-497943378.
# Some explanations:
#  - The `-d '\x00' --nth 4,6` is to only search within the author and commit
#    message fields. Fields are determined using the %x00 chars we inject.
#  - The `[ -z {2} ] || ...` syntax is to no-op correctly if on a line with
#    no commit info, which happens in graph output.
#  - The `ctrl-r:+reload` syntax means that the binding is additive rather
#    than replacing (after editing the commit message, we want to reload).

export FZF_DEFAULT_COMMAND="git log --graph --pretty=format:'%C(yellow)%x00%h%x00 %Cred%ad %x00%Cblue%an%Cgreen%x00%d %x00%Creset%s' --date=short --color=always $@"
fzf --ansi --no-sort --reverse --tiebreak=index -d '\x00' --nth 4,6  \
  --header 'View: Enter | Reload: C-S | Reload at commit: C-Space | Edit files: C-H | Edit commit: C-R | Rebase: Ctrl-B' \
  --preview '[ -z {2} ] || git show --color=always {2}' \
  --bind 'ctrl-d:half-page-down,ctrl-u:half-page-up' \
  --bind 'alt-e:preview-down,alt-y:preview-up,alt-d:preview-half-page-down,alt-u:preview-half-page-up' \
  --bind 'enter:execute([ -z {2} ] || git show --color=always {2} | less -R)' \
  --bind 'ctrl-space:execute([ -z {2} ] || git lgi {2})' \
  --bind 'ctrl-h:execute([ -z {2} ] || git edit {2})' \
  --bind 'ctrl-r:execute([ -z {2} ] || git reword {2})' \
  --bind "ctrl-r:+reload:${FZF_DEFAULT_COMMAND}" \
  --bind 'ctrl-b:execute([ -z {2} ] || git rebase -i {2})' \
  --bind "ctrl-b:+reload:${FZF_DEFAULT_COMMAND}" \
  --bind "ctrl-s:reload:${FZF_DEFAULT_COMMAND}"